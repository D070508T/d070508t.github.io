<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Broom Physics Simulation</title>

</head>

<body>

<label for="kP">kP:</label>
<input type="range" id="kP" value="0" step="0.001" min="0" max="1">
<br>
<label for="kD">kD:</label>
<input type="range" id="kD" value="0" step="0.001" min="0" max="0.05">
<br>
<label for="COM">CENTER OF MASS:</label>
<input type="range" id="COM" value="0.003" step="0.0002" min="0" max="0.01" size="100">
<br>
<button id="flickLeft">Flick Left</button>
<button id="flickRight">Flick Right</button>
<br>
<button id="reset">Reset</button>
<br>
<canvas id="canvas" width="800" height="500" style="border: 2px solid black;"></canvas>

<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const g = 10;
  const length = 200;
  const dt = 0.036;

  let theta = 0.01;
  let omega = 0;

  let tipX = canvas.width / 2;
  let tipY = canvas.height / 2 - length;

  let pivotX = canvas.width / 2;
  let pivotY = canvas.height / 2;

  let acceleration = 0;

  let error = 0;
  let previous_error = 0;

  let centerOfMass;

  let kP = document.getElementById('kP');
  kP.addEventListener('input', changeAcceleration);
  let kD = document.getElementById('kD');
  kD.addEventListener('input', changeAcceleration);

  let COM = document.getElementById('COM');
  COM.addEventListener('input', () => {centerOfMass = parseFloat(COM.value)});

  let flickLeft = document.getElementById('flickLeft');
  let flickRight = document.getElementById('flickRight');
  flickLeft.addEventListener('click', () => {theta = 2*Math.PI - Math.PI/4});
  flickRight.addEventListener('click', () => {theta = Math.PI/4});

  let reset_btn = document.getElementById('reset');
  reset_btn.addEventListener('click', () => {reset()});

  function changeAcceleration() {
    const p = parseFloat(kP.value) || 0;  // If the value is empty, set to 0
    const d = parseFloat(kD.value) || 0;  // Same for kD

    acceleration = -(
            p*error +
            d*(error - previous_error) / dt);
  }

  function updatePhysics() {
    changeAcceleration();

    pivotX += acceleration;

    omega += (g/length) * Math.sin(theta) * dt;
    omega -= acceleration * (centerOfMass ? centerOfMass : 0.003) * Math.cos(theta);
    theta += omega + dt;

    if (pivotX >= canvas.width || pivotX <= 0) reset();
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    previous_error = pivotX - tipX;

    tipX = pivotX + length * Math.sin(theta);
    tipY = pivotY - length * Math.cos(theta);

    error = pivotX - tipX;

    ctx.beginPath();
    ctx.moveTo(0, canvas.height/2);
    ctx.lineTo(canvas.width, canvas.height/2);
    ctx.strokeStyle = "black";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Draw the cart (square at pivot point)
    const cartSize = 20; // Size of the square in pixels
    ctx.fillStyle = "red"; // Cart color
    ctx.fillRect(
            pivotX - cartSize/2, // X position (centered)
            pivotY - cartSize/2, // Y position (centered)
            cartSize,
            cartSize
    );

    ctx.beginPath();
    ctx.moveTo(pivotX, pivotY);
    ctx.lineTo(tipX, tipY);
    ctx.lineWidth = 10;
    ctx.strokeStyle = "blue";
    ctx.stroke();
  }

  function reset() {
    theta = 0.01;
    omega = 0;
  }

  function loop() {
    updatePhysics();
    draw();
    requestAnimationFrame(loop);
  }

  loop();
</script>
</body>

</html>
